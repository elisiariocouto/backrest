function e(e,t,s,a){Object.defineProperty(e,t,{get:s,set:a,enumerable:!0,configurable:!0})}var t=globalThis.parcelRequire233b,s=t.register;s("9VL5o",function(s,a){e(s.exports,"SettingsModal",()=>q);var i=t("ayMG0"),l=t("4Uh7a"),r=t("iJ95P"),n=t("1gKZf"),d=t("bAJM4"),o=t("4To0s"),u=t("eTcXV"),c=t("jCenh"),h=t("3VOgd"),m=t("2lwvh"),p=t("93lJr"),f=t("acw62"),x=t("dkYnv"),y=t("54UqH"),j=t("8p4qI"),g=t("3JMMO"),b=t("lK1ug"),I=t("1VQWV"),w=t("1Yxub"),k=t("g0Gjq"),S=t("4l8Tp"),v=t("7nu3T"),P=t("6Os56"),C=t("2riGH"),T=t("h3NYq");let q=()=>{let[e,t]=(0,I.useConfig)(),s=(0,x.useShowModal)(),a=(0,g.useAlertApi)(),[r]=o.default.useForm(),[n,h]=(0,f.useState)([]),[m,y]=(0,f.useState)(!1),[j,v]=(0,f.useState)(!1);if(!e)return null;(0,f.useEffect)(()=>{let e=e=>{h(e)};return(0,C.subscribeToPeerStates)(e),()=>{(0,C.unsubscribeFromPeerStates)(e)}},[]);let T=async()=>{try{let s=await (0,b.validateForm)(r);if(s.auth?.users){for(let e of s.auth?.users)if(e.needsBcrypt){let t=await w.authenticationService.hashPassword({value:e.passwordBcrypt});e.passwordBcrypt=t.value,delete e.needsBcrypt}}let i=(0,k.clone)(P.ConfigSchema,e);if(i.auth=(0,S.fromJson)(P.AuthSchema,s.auth,{ignoreUnknownFields:!1}),i.multihost=(0,S.fromJson)(P.MultihostSchema,s.multihost,{ignoreUnknownFields:!1}),i.instance=s.instance,!i.auth?.users&&!i.auth?.disabled)throw Error("At least one user must be configured or authentication must be disabled");t(await w.backrestService.setConfig(i)),y(!0),a.success("Settings updated",5),v(!1)}catch(e){a.error((0,g.formatErrorAlert)(e,"Operation error: "),15)}},q=()=>{s(null),m&&window.location.reload()},M=e.auth?.users||[];return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(c.default,{open:!0,onCancel:q,title:"Settings",width:"60vw",footer:[(0,i.jsx)(l.default,{onClick:q,children:j?"Cancel":"Close"},"back"),(0,i.jsx)(l.default,{type:"primary",onClick:T,children:"Save"},"submit")],children:(0,i.jsxs)(o.default,{autoComplete:"off",form:r,labelCol:{span:4},wrapperCol:{span:20},onValuesChange:()=>v(!0),children:[M.length>0||e.auth?.disabled?null:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("strong",{children:"Initial backrest setup! "}),(0,i.jsx)("p",{children:"Backrest has detected that you do not have any users configured, please add at least one user to secure the web interface."}),(0,i.jsx)("p",{children:"You can add more users later or, if you forget your password, reset users by editing the configuration file (typically in $HOME/.backrest/config.json)"})]}),(0,i.jsx)(o.default.Item,{hasFeedback:!0,name:"instance",label:"Instance ID",required:!0,initialValue:e.instance||"",tooltip:"The instance name will be used to identify this backrest install. Pick a value carefully as it cannot be changed later.",rules:[{required:!0,message:"Instance ID is required"},{pattern:b.namePattern,message:"Instance ID must be alphanumeric with '_-.' allowed as separators"}],children:(0,i.jsx)(u.default,{placeholder:"Unique instance ID for this instance (e.g. my-backrest-server)",disabled:!!e.instance})}),(0,i.jsx)(d.default,{items:[{key:"1",label:"Authentication",forceRender:!0,children:(0,i.jsx)(N,{form:r,config:e})},{key:"2",label:"Multihost Identity and Sharing",forceRender:!0,children:(0,i.jsx)(A,{form:r,config:e,peerStates:n}),style:{display:"none"}},{key:"last",label:"Preview",children:(0,i.jsx)(o.default.Item,{shouldUpdate:!0,wrapperCol:{span:24},children:()=>(0,i.jsx)(p.default,{children:(0,i.jsx)("pre",{children:JSON.stringify(r.getFieldsValue(),null,2)})})})}]})]})})})},N=({form:e,config:t})=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.default.Item,{label:"Disable Authentication",name:["auth","disabled"],valuePropName:"checked",initialValue:t.auth?.disabled||!1,children:(0,i.jsx)(r.default,{})}),(0,i.jsx)(o.default.Item,{label:"Users",required:!0,children:(0,i.jsx)(o.default.List,{name:["auth","users"],initialValue:t.auth?.users?.map(e=>(0,v.toJson)(P.UserSchema,e,{alwaysEmitImplicit:!0}))||[],children:(t,{add:s,remove:a})=>(0,i.jsxs)(i.Fragment,{children:[t.map((t,s)=>(0,i.jsxs)(h.default,{gutter:16,children:[(0,i.jsx)(n.default,{span:11,children:(0,i.jsx)(o.default.Item,{name:[t.name,"name"],rules:[{required:!0,message:"Name is required"},{pattern:b.namePattern,message:"Name must be alphanumeric with dashes or underscores as separators"}],children:(0,i.jsx)(u.default,{placeholder:"Username"})})}),(0,i.jsx)(n.default,{span:11,children:(0,i.jsx)(o.default.Item,{name:[t.name,"passwordBcrypt"],rules:[{required:!0,message:"Password is required"}],children:(0,i.jsx)(u.default.Password,{placeholder:"Password",onFocus:()=>{e.setFieldValue(["auth","users",s,"needsBcrypt"],!0),e.setFieldValue(["auth","users",s,"passwordBcrypt"],"")}})})}),(0,i.jsx)(n.default,{span:2,children:(0,i.jsx)(y.default,{onClick:()=>{a(t.name)}})})]},t.key)),(0,i.jsx)(o.default.Item,{children:(0,i.jsxs)(l.default,{type:"dashed",onClick:()=>{s()},block:!0,children:[(0,i.jsx)(j.default,{})," Add user"]})})]})})})]}),A=({form:e,config:t,peerStates:s})=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(p.default.Paragraph,{italic:!0,children:"Multihost identity allows you to share repositories between multiple Backrest instances. This is useful for keeping track of the backup status of a collections of systems."}),(0,i.jsx)(p.default.Paragraph,{italic:!0,children:"This feature is experimental and may be subject to version incompatible changes in the future which will require all instances to be updated at the same time."}),(0,i.jsx)(o.default.Item,{label:"Multihost Identity",name:["multihost","identity","keyId"],initialValue:t.multihost?.identity?.keyid||"",rules:[{required:!0,message:"Multihost identity is required"}],tooltip:"Multihost identity is used to identify this instance in a multihost setup. It is cryptographically derived from the public key of this instance.",wrapperCol:{span:16},children:(0,i.jsxs)(h.default,{children:[(0,i.jsx)(n.default,{flex:"auto",children:(0,i.jsx)(u.default,{placeholder:"Unique multihost identity",disabled:!0,value:t.multihost?.identity?.keyid})}),(0,i.jsx)(n.default,{children:(0,i.jsx)(l.default,{type:"link",onClick:()=>-navigator.clipboard.writeText(t.multihost?.identity?.keyid||""),children:"copy"})})]})}),(0,i.jsx)(o.default.Item,{label:"Authorized Clients",tooltip:"Authorized clients are other Backrest instances that are allowed to access repositories on this instance.",children:(0,i.jsx)(M,{form:e,listName:["multihost","authorizedClients"],showInstanceUrl:!1,itemTypeName:"Authorized Client",peerStates:s,config:t,listType:"authorizedClients",initialValue:t.multihost?.authorizedClients?.map(e=>(0,v.toJson)(P.Multihost_PeerSchema,e,{alwaysEmitImplicit:!0}))||[]})}),(0,i.jsx)(o.default.Item,{label:"Known Hosts",tooltip:"Known hosts are other Backrest instances that this instance can connect to.",children:(0,i.jsx)(M,{form:e,listName:["multihost","knownHosts"],showInstanceUrl:!0,itemTypeName:"Known Host",peerStates:s,config:t,listType:"knownHosts",initialValue:t.multihost?.knownHosts?.map(e=>(0,v.toJson)(P.Multihost_PeerSchema,e,{alwaysEmitImplicit:!0}))||[]})})]}),M=({form:e,listName:t,showInstanceUrl:s,itemTypeName:a,peerStates:r,initialValue:n,config:d,listType:u})=>(0,i.jsx)(o.default.List,{name:t,initialValue:n,children:(t,{add:n,remove:c},{errors:h})=>(0,i.jsxs)(i.Fragment,{children:[t.map((t,a)=>(0,i.jsx)(U,{form:e,fieldName:t.name,remove:c,showInstanceUrl:s,peerStates:r,isKnownHost:"knownHosts"===u,index:a,config:d,listType:u},t.key)),(0,i.jsxs)(o.default.Item,{children:[(0,i.jsxs)(l.default,{type:"dashed",onClick:()=>n({}),block:!0,icon:(0,i.jsx)(j.default,{}),children:["Add ",a||"Peer"]}),(0,i.jsx)(o.default.ErrorList,{errors:h})]})]})}),U=({form:e,fieldName:t,remove:s,showInstanceUrl:a,peerStates:l,isKnownHost:d=!1,index:c,config:m,listType:p})=>{let f=d?e.getFieldValue(["multihost","knownHosts",c,"keyId"]):e.getFieldValue(["multihost","authorizedClients",c,"keyId"]),x=l.find(e=>e.peerKeyid===f);return(0,i.jsxs)("div",{style:{border:"1px solid #d9d9d9",borderRadius:"6px",padding:"16px",marginBottom:"16px",position:"relative"},children:[(0,i.jsxs)("div",{style:{position:"absolute",top:"8px",right:"8px",display:"flex",alignItems:"center",gap:"8px"},children:[x&&(0,i.jsx)(T.PeerStateConnectionStatusIcon,{peerState:x}),(0,i.jsx)(y.default,{style:{color:"#999",cursor:"pointer"},onClick:()=>s(t)})]}),(0,i.jsxs)(h.default,{gutter:16,children:[(0,i.jsx)(n.default,{span:10,children:(0,i.jsx)(o.default.Item,{name:[t,"instanceId"],label:"Instance ID",rules:[{required:!0,message:"Instance ID is required"},{pattern:b.namePattern,message:"Instance ID must be alphanumeric with '_-.' allowed as separators"}],children:(0,i.jsx)(u.default,{placeholder:"e.g. my-backup-server"})})}),(0,i.jsx)(n.default,{span:10,children:(0,i.jsx)(o.default.Item,{name:[t,"keyId"],label:"Key ID",rules:[{required:!0,message:"Key ID is required"}],children:(0,i.jsx)(u.default,{placeholder:"Public key identifier"})})}),(0,i.jsx)(n.default,{span:4,children:(0,i.jsx)(o.default.Item,{name:[t,"keyIdVerified"],valuePropName:"checked",children:(0,i.jsx)(r.default,{children:"Verified"})})})]}),a&&(0,i.jsx)(h.default,{gutter:16,children:(0,i.jsx)(n.default,{span:24,children:(0,i.jsx)(o.default.Item,{name:[t,"instanceUrl"],label:"Instance URL",rules:[{required:a,message:"Instance URL is required for known hosts"},{type:"url",message:"Please enter a valid URL"}],children:(0,i.jsx)(u.default,{placeholder:"https://example.com:9898"})})})}),(0,i.jsx)(R,{form:e,fieldName:t,listType:p,config:m})]})},R=({form:e,fieldName:t,listType:s,config:a})=>{let r=(a.repos||[]).map(e=>({label:e.id,value:`repo:${e.id}`}));return(0,i.jsxs)("div",{children:[(0,i.jsx)(p.default.Text,{strong:!0,style:{marginBottom:"8px",display:"block"},children:"Permissions"}),(0,i.jsx)(o.default.List,{name:[t,"permissions"],children:(e,{add:t,remove:s})=>(0,i.jsxs)(i.Fragment,{children:[e.map(e=>(0,i.jsx)("div",{style:{border:"1px solid #d9d9d9",borderRadius:"4px",padding:"12px",marginBottom:"8px",backgroundColor:"transparent"},children:(0,i.jsxs)(h.default,{gutter:8,align:"middle",children:[(0,i.jsx)(n.default,{span:11,children:(0,i.jsx)(o.default.Item,{name:[e.name,"type"],label:"Type",rules:[{required:!0,message:"Permission type is required"}],children:(0,i.jsxs)(m.default,{placeholder:"Select permission type",children:[(0,i.jsx)(m.default.Option,{value:P.Multihost_Permission_Type.PERMISSION_READ_WRITE_CONFIG,children:"Edit Repo Configuration"}),(0,i.jsx)(m.default.Option,{value:P.Multihost_Permission_Type.PERMISSION_READ_OPERATIONS,children:"Read Operations"})]})})}),(0,i.jsx)(n.default,{span:11,children:(0,i.jsx)(o.default.Item,{name:[e.name,"scopes"],label:"Scopes",rules:[{required:!0,message:"At least one scope is required"}],children:(0,i.jsx)(m.default,{mode:"multiple",placeholder:"Select repositories or use * for all",options:[{label:"All Repositories (*)",value:"*"},...r]})})}),(0,i.jsx)(n.default,{span:2,children:(0,i.jsx)(y.default,{style:{color:"#999",cursor:"pointer",fontSize:"16px"},onClick:()=>s(e.name)})})]})},e.key)),(0,i.jsx)(l.default,{type:"dashed",onClick:()=>t({type:P.Multihost_Permission_Type.PERMISSION_READ_OPERATIONS,scopes:["*"]}),icon:(0,i.jsx)(j.default,{}),size:"small",style:{width:"100%"},children:"Add Permission"})]})})]})}}),s("g0Gjq",function(s,a){e(s.exports,"clone",()=>n);var i=t("awiuc"),l=t("jzrYg"),r=t("aZnNp");function n(e,t){return d((0,l.reflect)(e,t)).message}function d(e){let t=(0,l.reflect)(e.desc);for(let s of e.fields)if(e.isSet(s))switch(s.fieldKind){case"list":let a=t.get(s);for(let t of e.get(s))a.add(o(s,t));break;case"map":let i=t.get(s);for(let t of e.get(s).entries())i.set(t[0],o(s,t[1]));break;default:t.set(s,o(s,e.get(s)))}let s=e.getUnknown();return s&&s.length>0&&t.setUnknown([...s]),t}function o(e,t){return void 0!==e.message&&(0,r.isReflectMessage)(t)?d(t):e.scalar==i.ScalarType.BYTES&&t instanceof Uint8Array?t.slice():t}});
//# sourceMappingURL=SettingsModal.2f9bcef4.js.map
